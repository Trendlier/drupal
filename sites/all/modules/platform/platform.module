<?php

module_load_include('php', 'platform', 'node_fun');

/**
 * Trendlier platform hooks for Drupal
 */

function platform_menu()
{
    return array(
        'platform/add_category_form' => array(
            'title' => 'Add Category',
            'page callback' => 'drupal_get_form',
            'page arguments' => array('platform_add_category_form'),
            'access callback' => TRUE,
            'type' => MENU_NORMAL_ITEM,
        ),
    );
}

function platform_add_category_form($form, &$form_state)
{
    return array(
        'add' => array(
            '#type' => 'fieldset',
            '#title' => t('Add a category to Trendlier app'),
            'name' => array(
                '#type' => 'textfield',
                '#title' => t('Name'),
                '#required' => TRUE,
                '#default_value' => '',
                '#description' => 'Name of category',
                '#size' => 20,
                '#maxlength' => 20,
            ),
            'submit' => array(
                '#type' => 'submit',
                '#value' => 'Add',
            ),
        ),
    );
}

function platform_add_category_form_submit($form, &$form_state)
{
    try
    {
        db_set_active('platform');

        $id = db_insert('category')
            ->fields(array(
                'name' => $form_state['values']['name'],
            ))
            ->execute();

        db_set_active();

        drupal_set_message(
            'Added ' . $form_state['values']['name'] . ' ' .
            '(ID ' . $id . ')');
    }
    catch (Exception $e)
    {
        drupal_set_message($e->getMessage(), 'error');
    }
}

function platform_insert_product($node)
{
    if ($node->type != 'product')
    {
        return;
    }

    $product = platform_get_product($node);

    db_set_active('platform');

    $now = new DateTime('now', new DateTimeZone('UTC'));

    $id = db_insert('product')
        ->fields(array(
            'title' => $product->title,
            'category_id' => $product->category_id,
            'subtitle' => $product->subtitle,
            'image_url' => $product->image_url,
            'image_width' => $product->image_width,
            'image_height' => $product->image_height,
            'description' => $product->description,
            'is_hidden' => $product->is_hidden,
            'created_utc' => $now->format('c'),
        ))
        ->execute();

    db_set_active();

    drupal_set_message(
            'Added ' . $product->title . ' ' .
            '(ID ' . $id . ')');

    db_insert('platform.product_node')
        ->fields(array(
            'product_id' => $id,
            'node_id' => $node->nid
        ))
        ->execute();
}

function platform_node_insert($node)
{
    try
    {
        platform_insert_product($node);
    }
    catch (Exception $e)
    {
        drupal_set_message($e->getMessage(), 'error');
    }
}
